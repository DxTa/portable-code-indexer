name: E2E Multi-Language Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  e2e-tests:
    name: E2E (${{ matrix.language }})
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        include:
          # Small repos chosen for fast CI (< 500 files each)
          - language: python
            repo_url: https://github.com/pallets/click
            sparse_paths: "src/click"
            keyword: "def"
            symbol: "Command"
            test_file: test_python_e2e.py
          
          - language: javascript
            repo_url: https://github.com/sindresorhus/slugify
            sparse_paths: ""
            keyword: "function"
            symbol: "slugify"
            test_file: test_javascript_e2e.py
          
          - language: typescript
            repo_url: https://github.com/sindresorhus/p-queue
            sparse_paths: "source"
            keyword: "function"
            symbol: "PQueue"
            test_file: test_typescript_e2e.py
          
          - language: go
            repo_url: https://github.com/spf13/pflag
            sparse_paths: ""
            keyword: "func"
            symbol: "FlagSet"
            test_file: test_go_e2e.py
          
          - language: rust
            repo_url: https://github.com/dtolnay/anyhow
            sparse_paths: "src"
            keyword: "fn"
            symbol: "Error"
            test_file: test_rust_e2e.py
          
          - language: java
            repo_url: https://github.com/google/gson
            sparse_paths: "gson/src/main"
            keyword: "class"
            symbol: "Gson"
            test_file: test_java_e2e.py
          
          - language: cpp
            repo_url: https://github.com/fmtlib/fmt
            sparse_paths: "include/fmt"
            keyword: "class"
            symbol: "format"
            test_file: test_cpp_e2e.py
          
          - language: csharp
            repo_url: https://github.com/ardalis/GuardClauses
            sparse_paths: "src"
            keyword: "class"
            symbol: "Guard"
            test_file: test_csharp_e2e.py
          
          - language: ruby
            repo_url: https://github.com/ruby/csv
            sparse_paths: "lib"
            keyword: "def"
            symbol: "CSV"
            test_file: test_ruby_e2e.py
          
          - language: php
            repo_url: https://github.com/ramsey/uuid
            sparse_paths: "src"
            keyword: "function"
            symbol: "Uuid"
            test_file: test_php_e2e.py

    steps:
      - name: Checkout sia-code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install sia-code with dev dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Clone target repository
        run: |
          if [ -n "${{ matrix.sparse_paths }}" ]; then
            echo "Cloning with sparse checkout: ${{ matrix.sparse_paths }}"
            git clone --filter=blob:none --sparse \
              ${{ matrix.repo_url }} target-repo
            cd target-repo
            git sparse-checkout set ${{ matrix.sparse_paths }}
          else
            echo "Cloning with shallow clone"
            git clone --depth 1 ${{ matrix.repo_url }} target-repo
          fi
          echo "Repository cloned successfully"
          ls -lh target-repo/ | head -20
      
      - name: Run E2E tests for ${{ matrix.language }}
        run: |
          pytest tests/e2e/${{ matrix.test_file }} \
            -v \
            --tb=short \
            --timeout=600 \
            --color=yes
        env:
          E2E_REPO_PATH: target-repo
          E2E_LANGUAGE: ${{ matrix.language }}
          E2E_KEYWORD: ${{ matrix.keyword }}
          E2E_SYMBOL: ${{ matrix.symbol }}

      - name: Embedding daemon status
        if: always()
        run: |
          sia-code embed status -v
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.language }}
          path: |
            target-repo/.sia-code/
            pytest-*.xml
            .coverage
          retention-days: 7
      
      - name: Upload sia-code index for debugging
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: debug-index-${{ matrix.language }}
          path: target-repo/.sia-code/
          retention-days: 3

  summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Display summary
        run: |
          echo "## E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Language | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for lang in python javascript typescript go rust java cpp csharp ruby php; do
            if [ -d "test-results/e2e-results-$lang" ]; then
              echo "| $lang | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $lang | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Languages Tested:** 10" >> $GITHUB_STEP_SUMMARY
